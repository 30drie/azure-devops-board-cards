<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="lib/VSS.SDK.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true, 
            usePlatformStyles: true
        });
        VSS.register("backlogTabObject", {
            pageTitle: function(state) {
                return "Print board cards";
            },
            updateContext: function(tabContext) {                            
            },
            isInvisible: function(state) {
                return false;
            },
            isDisabled: function(state) {
                return false;
            }
        });
        function configure() {
            VSS.getService(VSS.ServiceIds.Dialog).then(function(dialogService) {
                var configurationForm;
                var extensionCtx = VSS.getExtensionContext();
                var contributionId = extensionCtx.publisherId + "." + extensionCtx.extensionId + ".configuration";
                var dialogOptions = {
                    title: "Configuration options",
                    width: 800,
                    height: 600,
                    getDialogResult: function() {
                        // Get the result from configurationForm object
                        return configurationForm ? configurationForm.getFormData() : null;
                    },
                    okCallback: function (result) {
                        // Log the result to the console
                        console.log(JSON.stringify(result));
                    }
                };
                dialogService.openDialog(contributionId, dialogOptions).then(function(dialog) {
                    // Get configurationForm instance which is registered in configurationForm.html
                    dialog.getContributionInstance("configuration").then(function (configurationFormInstance) {

                        // Keep a reference of registration form instance (to be used above in dialog options)
                        configurationForm = configurationFormInstance;

                        // Subscribe to form input changes and update the Ok enabled state
                        configurationForm.attachFormChanged(function(isValid) {
                            dialog.updateOkButton(isValid);
                        });

                        // Set the initial ok enabled state
                        configurationForm.isFormValid().then(function (isValid) {
                            dialog.updateOkButton(isValid);
                        });
                    });                            
                });

            });
        }
        VSS.ready(function () {
            console.log('VSS has said it is ready. Here we go ');
                document.getElementById("configureButton").addEventListener("click", function(event){
                configure();
                event.preventDefault();
            });
            VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                var collection = 'board-cards-ext-collection';
                var configDoc = 'board-cards-config';
                dataService.getDocument(collection,configDoc).then(function(doc) {
                    // document exists
                    console.log("Configuration document exists.  Content follows:");
                    console.log(doc);
                    /*
                    for (var key in doc) {
                        if (doc.hasOwnProperty(key)) {
                            if(key == 'id') {
                                console.log('Skipping id element');
                            } else if (key == '__etag') {
                                console.log('Skipping __etag element');
                            } else {
                                let div = document.createElement('div');
                                let className = 'config-' + key;
                                div.className = className;
                                div.innerHTML = '<label for="' + key + '">' + key + ': </label><input type=text id="' + key + '" name="' + key + '" value="' + doc[key] + '>';
                                document.getElementById("config").appendChild(div);
                                console.log(key + " -> " + doc[key]);
                            }
                        }
                    } */
                },function(err) {
                    // console.log(err)
                    if(err.status == '404') {
                        console.log("No document found, creating default document.");
                        defaultConfig = {
                            "id": configDoc,
                            "user-story": "SlateBlue",
                            "task": "Gold",
                            "bug": "Tomato",
                            "epic": "DarkOrange",
                            "feature": "LightGreen",
                            "issue": "SeaGreen"
                        }
                        dataService.setDocument(collection,defaultConfig).then(function(doc) {
                            console.log('Setting document as follows:');
                            console.log("Doc id: " + doc.id);
                            console.log(doc);
                            console.log("Reloading window");
                            location.reload();
                        });
                    } else {
                        console.log("An error occurred.");
                        console.log(err);
                        alert("The extension was unable to find or create the config document.  The error has been written to the browser console.");
                    }
                })
            })     
            VSS.require([
                "VSS/Service",
                "TFS/WorkItemTracking/RestClient",
                "TFS/WorkItemTracking/Contracts"
                ], function (VSS_Service, TFS_WorkItemTracking_RestClient, TFS_WorkItemTracking_Contracts) {
                    var client = VSS_Service.getCollectionClient(TFS_WorkItemTracking_RestClient.WorkItemTrackingHttpClient); 
                    var query = {'query': 'SELECT [System.Id] FROM WorkItems WHERE [System.IterationPath] = @CurrentIteration'};
                    var context = VSS.getWebContext();
                    var projectId = context.project.id;
                    var project = context.project.name;
                    // console.log('#1 - Querying for all work items in current iteration');
                    return client.queryByWiql(query, projectId).then(function(result) {
                        var workItemIds = [];
                        workItemIds = result.workItems.map(function (val) { return val.id; });
                        // console.log('#2 - Querying for work items returned');
                        var sheetCount = 0;
                        var workItemDetails = client.getWorkItems(workItemIds,undefined,undefined,4).then(function(workItems) {
                            for(var x = 0; x < workItems.length; x++) {
                                let id = workItems[x].id;
                                let title = workItems[x].fields['System.Title'];
                                let type = workItems[x].fields['System.WorkItemType'];
                                let workItemParentId = '';
                                if (workItems[x].relations) {
                                    workItems[x].relations.forEach(function (relation) {
                                        if (relation.rel === 'System.LinkTypes.Hierarchy-Reverse') {
                                            let parentId = relation.url.split('/').slice(-1)[0];
                                            workItemParentId = parentId;
                                            //console.log('Calling getWorkItem() with: ' + parentId);
                                            let parentItemDetails = client.getWorkItem(parentId);
                                            console.log(parentItemDetails);
                                            function listAllProperties(parentItemDetails) {
                                                var objectToInspect;     
                                                var result = [];
                                                
                                                for(objectToInspect = o; objectToInspect !== null; 
                                                    objectToInspect = Object.getPrototypeOf(objectToInspect)) {  
                                                    result = result.concat(
                                                        Object.getOwnPropertyNames(objectToInspect)
                                                    );  
                                                }
                                                console.log(result); 
                                            }
                                        }
                                    })
                                }
                                if(x == 0) {
                                    let section = document.createElement('section');
                                    section.className = 'sheet padding-10mm';
                                    //console.log('sheetCount is: ' + sheetCount);
                                    var sheetId = 'sheet' + sheetCount;
                                    section.id = sheetId;
                                    document.getElementById("main").appendChild(section);
                                } else if (x % 15 === 0 && x != 0) {
                                    let section = document.createElement('section');
                                    section.className = 'sheet padding-10mm';
                                    //console.log('sheetCount is: ' + sheetCount);
                                    var sheetId = 'sheet' + sheetCount;  
                                    section.id = sheetId;
                                    document.getElementById("main").appendChild(section);
                                }
                                console.log('workItemParentId: ' + workItemParentId)
                                let styleType = type.replace(/\s+/g, '-').toLowerCase();
                                let div = document.createElement('div');
                                let className = 'workItem ' + styleType + ' ' + id + ' ' + x;
                                div.className = className;
                                let cardCount = x + 1;
                                if(cardCount % 15 === 0 && x != 0) {
                                    // console.log('Ending sheet at ' + cardCount);
                                    div.innerHTML = '<div class="type">' + type + '</div><div class="id">' + id + '</div><div class="title">' + title + '</div><div class="parent-id">Parent: <strong>' + workItemParentId + '</div><div class="parent-name"></div></section>';
                                    sheetCount++;
                                } else {
                                    // console.log('No need to start or end sheet (' + cardCount + ')');
                                    div.innerHTML = '<div class="type">' + type + '</div><div class="id">' + id + '</div><div class="title">' + title + '</div><div class="parent-id">Parent: <strong>' + workItemParentId + '</div><div class="parent-name"></div>';
                                }
                                // console.log('About to try and append child to sheetId:' + sheetId);
                                document.getElementById(sheetId).appendChild(div);
                                // console.log('Loop completed: ' + x);

                            }
                            window.focus();
                            window.print();
                        }); 
                    });
                }
            );
        });
        VSS.notifyLoadSucceeded();
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css">
    <link rel="stylesheet" media="all" href="css/cards.css">
    <link rel="stylesheet" media="screen" href="css/screen.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.4.1/paper.min.css">
    <style>@page { size: A4 }</style>
</head>
<body class="board-cards a4">
    <main id="main">
        <h1>Print board cards</h1>
        <form id="config-form">
            <div id="config">
                    <button id="configureButton">Configure extension</button>
            </div>
        </form>
    </main>
</body>
</html>