<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="lib/VSS.SDK.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true, 
            usePlatformStyles: true
        });
        VSS.register("backlogTabObject", {
            pageTitle: function(state) {
                return false;
            },
            updateContext: function(tabContext) {                            
            },
            isInvisible: function(state) {
                return false;
            },
            isDisabled: function(state) {
                return false;
            }
        });
        VSS.require([
                "VSS/Service",
                "TFS/WorkItemTracking/RestClient",
                "TFS/WorkItemTracking/Contracts"
                ]);
        function configure() {
            VSS.getService(VSS.ServiceIds.Dialog).then(function(dialogService) {
                var configurationForm;
                var extensionCtx = VSS.getExtensionContext();
                var contributionId = extensionCtx.publisherId + "." + extensionCtx.extensionId + ".configuration";
                var dialogOptions = {
                    title: "Configuration options",
                    width: 800,
                    height: 600,
                    getDialogResult: function() {
                        // Get the result from configurationForm object
                        return configurationForm ? configurationForm.getFormData() : null;
                    },
                    okCallback: function (result) {

                    }
                };
                dialogService.openDialog(contributionId, dialogOptions).then(function(dialog) {
                    // Get configurationForm instance which is registered in configurationForm.html
                    dialog.getContributionInstance("configuration").then(function (configurationFormInstance) {

                        // Keep a reference of registration form instance (to be used above in dialog options)
                        configurationForm = configurationFormInstance;

                        // Subscribe to form input changes and update the Ok enabled state
                        configurationForm.attachFormChanged(function(isValid) {
                            dialog.updateOkButton(isValid);
                        });

                        // Set the initial ok enabled state
                        configurationForm.isFormValid().then(function (isValid) {
                            dialog.updateOkButton(isValid);
                        });
                    });                            
                });

            });
        } 
        VSS.ready(function () {
            VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                var collection = 'board-cards-ext-collection';
                var configDoc = 'board-cards-config';
                dataService.getDocument(collection,configDoc).then(function(doc) {
                },function(err) {
                    if(err.status == '404') {
                        defaultConfig = {
                            "id": configDoc,
                            "user-story": "SlateBlue",
                            "task": "Gold",
                            "bug": "Tomato",
                            "epic": "DarkOrange",
                            "feature": "LightGreen",
                            "issue": "SeaGreen"
                        }
                        dataService.setDocument(collection,defaultConfig).then(function(doc) {
                            location.reload();
                        });
                    } else {
                        alert("The extension was unable to find or create the config document.  The error has been written to the browser console.");
                    }
                })
            })     
            VSS.require([
                "VSS/Service",
                "TFS/WorkItemTracking/RestClient",
                "TFS/WorkItemTracking/Contracts"
                ], async function (VSS_Service, TFS_WorkItemTracking_RestClient, TFS_WorkItemTracking_Contracts) {
                    var witClient = VSS_Service.getCollectionClient(TFS_WorkItemTracking_RestClient.WorkItemTrackingHttpClient);
                    var context = VSS.getWebContext();
                    var projectId = context.project.id;
                    var project = context.project.name;
                    var sheetCount = 0;
                    var query = {'query': 'SELECT [System.Id] FROM WorkItems WHERE [System.IterationPath] = @CurrentIteration'};
                    let queryResult = await witClient.queryByWiql(query, projectId);
                    let workItemIds = await queryResult.workItems.map(function (val) { return val.id; });
                    let workItemDetails = await witClient.getWorkItems(workItemIds,undefined,undefined,4);
                    for(var x = 0; x < workItemDetails.length; x++) {
                        let id = workItemDetails[x].id;
                        let title = workItemDetails[x].fields['System.Title'];
                        let type = workItemDetails[x].fields['System.WorkItemType'];
                        let styleType = type.replace(/\s+/g, '-').toLowerCase();
                        
                        if(x === 0) {
                            let section = document.createElement('section');
                            section.className = 'sheet padding-10mm';
                            var sheetId = 'sheet' + sheetCount;
                            section.id = sheetId;
                            document.getElementById("main").appendChild(section);
                        } else if (x % 15 === 0 && x != 0) {
                            let section = document.createElement('section');
                            section.className = 'sheet padding-10mm';
                            var sheetId = 'sheet' + sheetCount;  
                            section.id = sheetId;
                            document.getElementById("main").appendChild(section);
                        }

                        let div = document.createElement('div');
                        let className = 'workItem ' + styleType + ' ' + id + ' ' + x;
                        div.className = className;
                        let cardCount = x + 1;
                        const stringParts = [];
                        stringParts.push(`<div class="type truncate">${type}</div><div class="id">${id}</div><div class="title">${title}</div>`);
                        if (workItemDetails[x].relations) { 
                            const { url } = 
                            workItemDetails[x].relations.find(
                                ({ rel }) => rel ===  'System.LinkTypes.Hierarchy-Reverse'
                            );  
                            //const splitted = url.split('/').slice(-1)[0];
                            const parentId = url.split('/').slice(-1)[0];
                            //console.log(`Parent ID: ${parentId}`);
                            //console.log(`getParentID() called with ${parentId}`);
                            const { fields } = await witClient.getWorkItem(parentId, ['System.Title']);
                            //console.log(JSON.stringify(fields));
                            const parentWorkItemTitleString = await fields['System.Title'];
                            //console.log(`parentWorkItemTitleString: ${parentWorkItemTitleString}`);
                            stringParts.push(`<div class="parent"><span class="parent-id">${parentId}</span><span class="parent-name"> ${parentWorkItemTitleString}</span></div>`)
                        }
                        if(cardCount % 15 === 0 && x != 0) {
                            stringParts.push('</section>');
                            sheetCount++;
                        } 
                        while (div.hasChildNodes()) {
                            div.firstChild.remove();
                        }
                        let stringToInsert = stringParts.join("");
                        console.log(`stringToInsert: ${stringToInsert}`);
                        div.insertAdjacentHTML("beforeend", stringToInsert);
                        document.getElementById(sheetId).appendChild(div);      
                    }
                    window.focus();
                    window.print();
                })
            })
        VSS.notifyLoadSucceeded();
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css">
    <link rel="stylesheet" media="all" href="css/cards.css">
    <link rel="stylesheet" media="screen" href="css/screen.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.4.1/paper.min.css">
    <style>@page { size: A4 }</style>
</head>
<body class="board-cards a4">
    <main id="main">
    </main>
</body>
</html>