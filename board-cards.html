<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="lib/VSS.SDK.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformScripts: true, 
            usePlatformStyles: true
        });
        VSS.register("backlogTabObject", {
            pageTitle: function(state) {
                return false;
            },
            updateContext: function(tabContext) {                            
            },
            isInvisible: function(state) {
                return false;
            },
            isDisabled: function(state) {
                return false;
            }
        });
        VSS.require([
                "VSS/Service",
                "TFS/WorkItemTracking/RestClient",
                "TFS/WorkItemTracking/Contracts"
                ]);
        VSS.ready(function () {           
            VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                var collection = 'board-cards-ext-collection';
                var configDoc = 'board-cards-config';
                dataService.getDocument(collection,configDoc).then(function(doc) {
                },function(err) {
                    if(err.status == '404') {
                        defaultConfig = {
                            "id": configDoc,
                            "user-story": "SlateBlue",
                            "task": "Gold",
                            "bug": "Tomato",
                            "epic": "DarkOrange",
                            "feature": "LightGreen",
                            "issue": "SeaGreen"
                        }
                        dataService.setDocument(collection,defaultConfig).then(function(doc) {
                            location.reload();
                        });
                    } else {
                        alert("The extension was unable to find or create the config document.  The error has been written to the browser console.");
                    }
                })
            })     
            VSS.require([
                "VSS/Service",
                "TFS/WorkItemTracking/RestClient",
                "TFS/WorkItemTracking/Contracts",
                "TFS/Work/RestClient"
                ], 
                    async function (VSS_Service, TFS_WorkItemTracking_RestClient, TFS_WorkItemTracking_Contracts, TFS_Work_RestClient) {
                    let client = TFS_Work_RestClient.getClient();
                    let context = VSS.getWebContext();
                    let teamContext = { projectId: context.project.id, teamId: context.team.id, project: "", team: "" };
                    let ul = document.getElementById("iterationPaths");
                    let teamIterations = client.getTeamIterations(teamContext).then(function(iterations) {
                        let configurationDiv = document.getElementById('configuration');
                        for(let x = 0; x < iterations.length; x++) {
                            let iterationPathId = iterations[x].id;
                            let iterationPath = iterations[x].path;
                            let startDate = iterations[x].attributes['startDate'];
                            let endDate = iterations[x].attributes['finishDate'];
                            let todayDate = new Date();
                            let li = document.createElement("li");
                            let a = document.createElement('a');
                            let linkText = '';
                            if(todayDate > startDate && todayDate < endDate){
                                linkText = document.createTextNode(iterationPath + " (Active iteration)");
                            } else {
                                linkText = document.createTextNode(iterationPath);
                            }
                            a.appendChild(linkText);
                            a.title = iterationPath;
                            a.href = "'#'";
                            a.onclick = function() {                        
                                // Get data service
                                VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                                    // Set value in user scope
                                    dataService.setValue("userIterationPath", iterationPath, {scopeType: "User"}).then(function(value) {
                                        console.log("Iteration path is now " + value);
                                    });
                                });
                                return false;
                            }
                            li.appendChild(a);
                            ul.appendChild(li);

                        }
                    });

                    var witClient = VSS_Service.getCollectionClient(TFS_WorkItemTracking_RestClient.WorkItemTrackingHttpClient);  
                    var projectId = context.project.id;
                    var project = context.project.name;
                    var sheetCount = 0;
                    var query = {'query': 'SELECT [System.Id] FROM WorkItems WHERE [System.IterationPath] = @CurrentIteration'};
                    let queryResult = await witClient.queryByWiql(query, projectId);
                    let workItemIds = await queryResult.workItems.map(function (val) { return val.id; });
                    let workItemDetails = await witClient.getWorkItems(workItemIds,undefined,undefined,4);
                    for(var x = 0; x < workItemDetails.length; x++) {
                        let id = workItemDetails[x].id;
                        let title = workItemDetails[x].fields['System.Title'];
                        let type = workItemDetails[x].fields['System.WorkItemType'];
                        let styleType = type.replace(/\s+/g, '-').toLowerCase();
                        
                        if(x === 0) {
                            let section = document.createElement('section');
                            section.className = 'sheet padding-10mm';
                            var sheetId = 'sheet' + sheetCount;
                            section.id = sheetId;
                            document.getElementById("main").appendChild(section);
                        } else if (x % 15 === 0 && x != 0) {
                            let section = document.createElement('section');
                            section.className = 'sheet padding-10mm';
                            var sheetId = 'sheet' + sheetCount;  
                            section.id = sheetId;
                            document.getElementById("main").appendChild(section);
                        }

                        let div = document.createElement('div');
                        let className = 'workItem ' + styleType + ' ' + id + ' ' + x;
                        div.className = className;
                        let cardCount = x + 1;
                        const stringParts = [];
                        stringParts.push(`<div class="type truncate">${type}</div><div class="id">${id}</div><div class="title">${title}</div>`);
                        if (workItemDetails[x].relations) { 
                            const { url }  = 
                            workItemDetails[x].relations.find(
                                ({ rel }) => rel ===  'System.LinkTypes.Hierarchy-Reverse'
                            );
                            if(url){
                                
                                const parentId = url.split('/').slice(-1)[0];
                                const { fields } = await witClient.getWorkItem(parentId, ['System.Title']);
                                console.log(url);
                                const parentWorkItemTitleString = await fields['System.Title'];
                                stringParts.push(`<div class="parent"><span class="parent-id">${parentId}</span><span class="parent-name"> ${parentWorkItemTitleString}</span></div>`) 
                            }
                            
                        }
                        if(cardCount % 15 === 0 && x != 0) {
                            stringParts.push('</section>');
                            sheetCount++;
                        } 
                        while (div.hasChildNodes()) {
                            div.firstChild.remove();
                        }
                        let stringToInsert = stringParts.join("");
                        div.insertAdjacentHTML("beforeend", stringToInsert);
                        document.getElementById(sheetId).appendChild(div);      
                    }
                    
                    window.focus();
                    window.print();
                })
            })
        VSS.notifyLoadSucceeded();
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css">
    <link rel="stylesheet" media="all" href="css/cards.css">
    <link rel="stylesheet" media="screen" href="css/screen.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.4.1/paper.min.css">
    <link rel="sytlesheet" media="print" href="css/print.css">
    <style>@page { size: A4 }</style>
</head>
<body class="board-cards a4">
    <header id="header">
        <div id="configuration">
            <ul id="iterationPaths">

            </ul>
            <a href="#" onclick="window.focus();window.print();">Print</a>
        </div>
    </header>
    <main id="main">
    </main>
</body>
</html>